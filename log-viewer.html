<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Lighthouse Log Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background: #0d1117;
        color: #d1d5da;
        font-family: monospace;
        margin: 0;
        padding: 2rem;
      }
      h1 {
        color: #58a6ff;
        margin-bottom: 1rem;
      }
      #controls {
        margin-bottom: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
      }
      select,
      button,
      label {
        font-family: sans-serif;
        font-size: 0.9rem;
        padding: 0.4rem 0.6rem;
        border-radius: 6px;
        border: none;
        background: #21262d;
        color: #d1d5da;
        cursor: pointer;
      }
      button:hover {
        background: #30363d;
      }
      pre {
        background: #161b22;
        padding: 1rem;
        border-radius: 10px;
        overflow-x: auto;
        max-height: 75vh;
        white-space: pre-wrap;
        line-height: 1.5;
        font-size: 0.9rem;
        box-shadow: 0 0 8px #000;
      }
    </style>
  </head>
  <body>
    <h1>üìú Lighthouse Log Viewer</h1>

    <div id="controls">
      <select id="logSelector">
        <option disabled selected>Loading log files‚Ä¶</option>
      </select>

      <button id="refreshBtn">üîÅ Refresh Now</button>

      <label>
        <input type="checkbox" id="autoRefresh" />
        üîÑ Auto-refresh (10s)
      </label>

      <label>
        <input type="checkbox" id="scrollLock" checked />
        üåÄ Auto-scroll to bottom
      </label>
    </div>

    <pre id="log">Waiting for log...</pre>

    <script>
      const logFolder = "/logs/system/";
      let currentLog = "";
      let refreshTimer = null;

      const logEl = document.getElementById("log");
      const logSelector = document.getElementById("logSelector");
      const autoRefresh = document.getElementById("autoRefresh");
      const scrollLock = document.getElementById("scrollLock");
      const refreshBtn = document.getElementById("refreshBtn");

      function fetchLog(filename) {
        if (!filename) return;
        currentLog = filename;
        fetch(logFolder + filename)
          .then((res) => {
            if (!res.ok) throw new Error("Failed to load log.");
            return res.text();
          })
          .then((text) => {
            logEl.textContent = text;
            if (scrollLock.checked) {
              window.scrollTo(0, document.body.scrollHeight);
            }
          })
          .catch((err) => {
            logEl.textContent = `‚ö†Ô∏è ${err.message}`;
          });
      }

      function fetchLogList() {
        fetch(logFolder)
          .then((res) => res.text())
          .then((html) => {
            const files = [...html.matchAll(/href="([^"]+\.log)"/g)]
              .map((m) => m[1])
              .filter((f) => f.includes("startup") || f.includes(".log"));

            const sorted = files.sort((a, b) => {
              const getDate = (name) => {
                const match = name.match(/(\d{4}-\d{2}-\d{2}_\d{4})/);
                return match
                  ? new Date(
                      match[1]
                        .replace("_", "T")
                        .replace(/(\d{2})(\d{2})$/, "$1:$2")
                    )
                  : 0;
              };
              return getDate(b) - getDate(a);
            });

            if (!sorted.length) {
              logSelector.innerHTML = `<option disabled>No log files found</option>`;
              return;
            }

            logSelector.innerHTML = sorted
              .map((f) => `<option value="${f}">${f}</option>`)
              .join("");

            fetchLog(sorted[0]);
          })
          .catch((err) => {
            logSelector.innerHTML = `<option disabled>Error loading logs</option>`;
            logEl.textContent = `‚ö†Ô∏è ${err.message}`;
          });
      }

      logSelector.addEventListener("change", () => {
        fetchLog(logSelector.value);
      });

      autoRefresh.addEventListener("change", () => {
        if (autoRefresh.checked) {
          refreshTimer = setInterval(() => fetchLog(currentLog), 10000);
        } else {
          clearInterval(refreshTimer);
          refreshTimer = null;
        }
      });

      refreshBtn.addEventListener("click", () => {
        fetchLog(currentLog);
      });

      fetchLogList();
    </script>
  </body>
</html>
