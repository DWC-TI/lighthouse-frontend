<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Lighthouse Server Status</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        background: linear-gradient(160deg, #f6f8fa 70%, #e9e6e0 100%);
        color: #18305c;
        font-family: "Inter", Arial, sans-serif;
        text-align: center;
        margin: 0;
        padding: 0;
      }
      .status-card,
      .sprint-card {
        margin: 60px auto 0 auto;
        background: var(--lh-card, #fffbe7);
        border-radius: 2rem;
        box-shadow: 0 4px 24px #18305c18;
        padding: 2.3rem 2rem 2rem 2rem;
        max-width: 440px;
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 2px solid #ffe066;
      }
      .sprint-card {
        margin-top: 36px;
        padding-top: 1.7rem;
        padding-bottom: 1.5rem;
      }
      .lighthouse-emoji {
        font-size: 3.6em;
        margin-bottom: 0.4em;
      }
      .status-ok {
        color: #24a17c;
        font-weight: bold;
        font-size: 1.22em;
        margin-bottom: 0.7em;
      }
      .dashboard-link {
        display: inline-block;
        margin-top: 2em;
        color: #18305c;
        font-weight: 600;
        font-size: 1.11em;
        text-decoration: none;
        border-bottom: 1px solid #ffe066;
        padding-bottom: 3px;
        transition: color 0.15s;
      }
      .dashboard-link:hover {
        color: #fa7268;
      }
      .sprint-title {
        font-weight: 700;
        margin-bottom: 0.35em;
        font-size: 1.17em;
        color: #fa7268;
        letter-spacing: 0.01em;
      }
      .project-name {
        font-weight: 600;
        font-size: 1em;
        color: #18305cbb;
        margin-bottom: 0.1em;
      }
      .tasks-list {
        margin: 0.6em 0 0 0;
        padding: 0;
        list-style: none;
        text-align: left;
        width: 100%;
        max-width: 320px;
        margin-left: auto;
        margin-right: auto;
      }
      .tasks-list li {
        background: #f8f7ee;
        margin-bottom: 0.45em;
        border-radius: 0.7em;
        padding: 0.45em 1em 0.45em 0.8em;
        color: #18305ca8;
        font-size: 1.01em;
        box-shadow: 0 1px 4px #fa726822;
        display: flex;
        align-items: center;
      }
      .tasks-list li .status-dot {
        display: inline-block;
        width: 1em;
        margin-right: 0.6em;
        font-size: 1.1em;
      }
      .sprint-status {
        color: #24a17c;
        font-size: 0.97em;
        font-weight: 500;
        margin-bottom: 0.4em;
      }
      .no-sprint {
        color: #fa7268;
        font-size: 1.05em;
        margin-top: 0.7em;
        font-weight: 500;
      }
      code {
        background: #f0f0f0;
        padding: 2px 4px;
        border-radius: 4px;
        font-size: 0.95em;
      }
      @media (max-width: 500px) {
        .status-card,
        .sprint-card {
          padding: 1.4rem 0.3rem 1.4rem 0.3rem;
          max-width: 97vw;
        }
        .tasks-list li {
          font-size: 0.98em;
        }
      }
    </style>
  </head>
  <body>
    <div class="status-card">
      <div class="lighthouse-emoji">üö¶üè†</div>
      <div class="status-ok" id="status">Checking server status‚Ä¶</div>
      <div id="servertime"></div>
      <a href="index.html" class="dashboard-link">‚Üê Back to Dashboard</a>
    </div>

    <div class="sprint-card">
      <div class="sprint-title" id="sprint-title">Checking project data‚Ä¶</div>
      <div id="sprint-content">
        <span style="color: #aaa">Please wait‚Ä¶</span>
      </div>
    </div>

    <script>
      fetch("http://localhost:3001/status")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("status").innerHTML = `
            Server is UP and running üü¢<br>
            <span style="font-size:0.92em;color:#18305c99;">
              Active ports:<br>
              ‚Ä¢ Backend: <code>3001</code><br>
              ‚Ä¢ Frontend: <code>8080</code>
            </span>
          `;
          const timeMatch = html.match(/Time:\s?([^\<]+)/);
          if (timeMatch) {
            document.getElementById("servertime").innerHTML =
              "<span style='font-size:0.99em;color:#18305c99;'>Time: " +
              timeMatch[1] +
              "</span>";
          }

          // Enhanced project fetch with diagnostics
          fetch("http://localhost:3001/api/projects")
            .then(async (res) => {
              const contentType = res.headers.get("Content-Type");
              const status = res.status;
              const titleEl = document.getElementById("sprint-title");
              const box = document.getElementById("sprint-content");

              if (!res.ok) {
                const text = await res.text();
                titleEl.textContent = `‚ùå Error ${status}`;
                box.innerHTML = `
                  <div class='no-sprint'>
                    Failed to fetch project data.<br>
                    <b>Status:</b> ${status}<br>
                    <b>Message:</b> ${res.statusText}<br>
                    <b>Raw:</b> <code>${text.slice(0, 200)}</code>
                  </div>`;
                console.error("‚ùå Response error:", text);
                return;
              }

              if (!contentType || !contentType.includes("application/json")) {
                titleEl.textContent = "‚ö†Ô∏è Invalid response";
                box.innerHTML = `
                  <div class='no-sprint'>
                    Expected JSON but got: <code>${contentType || "none"}</code>
                  </div>`;
                return;
              }

              let projects;
              try {
                projects = await res.json();
              } catch (jsonErr) {
                titleEl.textContent = "‚ùå Invalid JSON";
                box.innerHTML = `
                  <div class='no-sprint'>
                    Could not parse project data.<br>
                    <b>Error:</b> ${jsonErr.message}
                  </div>`;
                console.error("‚ùå JSON parse error:", jsonErr);
                return;
              }

              console.log("‚úÖ Raw project data:", projects);

              if (!Array.isArray(projects)) {
                titleEl.textContent = "‚ö†Ô∏è Invalid data format";
                box.innerHTML =
                  "<div class='no-sprint'>Could not read project data (invalid format).</div>";
                return;
              }

              if (!projects.length) {
                titleEl.textContent = "‚ö†Ô∏è No projects found";
                box.innerHTML =
                  "<div class='no-sprint'>Your projects.json file is empty.</div>";
                return;
              }

              let found = null,
                projectName = "";

              for (const p of projects) {
                const active = (p.sprints || []).find(
                  (s) => s.status === "active"
                );
                if (active) {
                  found = active;
                  projectName = p.name;
                  break;
                }
              }

              if (!found && projects[0].sprints && projects[0].sprints.length) {
                found = projects[0].sprints[0];
                projectName = projects[0].name;
              }

              if (found) {
                titleEl.textContent = "üõ†Ô∏è Active Sprint";
                box.innerHTML = `
                  <div class="project-name">${projectName}</div>
                  <div style="color:#18305c;font-size:1.1em;margin-bottom:0.3em;"><b>${
                    found.name
                  }</b></div>
                  <div class="sprint-status">${
                    found.status === "active"
                      ? "Currently active"
                      : "Next sprint"
                  }</div>
                  <ul class="tasks-list">
                    ${
                      found.tasks?.length
                        ? found.tasks
                            .map(
                              (t) =>
                                `<li>
                                  <span class="status-dot">${
                                    t.done ? "‚úÖ" : "‚¨ú"
                                  }</span>
                                  ${t.title}
                                </li>`
                            )
                            .join("")
                        : `<li><span class="status-dot">üí°</span>No tasks in sprint.</li>`
                    }
                  </ul>
                `;
              } else {
                titleEl.textContent = "‚ö†Ô∏è No sprint found";
                box.innerHTML = `<div class='no-sprint'>No sprints found in your project list.</div>`;
              }
            })
            .catch((err) => {
              console.error("‚ùå Network or fetch error:", err);
              document.getElementById("sprint-title").textContent =
                "‚ùå Fetch failed";
              document.getElementById("sprint-content").innerHTML = `
                <div class='no-sprint'>
                  Could not load project data.<br>
                  <b>Error:</b> ${err.message}
                </div>`;
            });
        })
        .catch(() => {
          document.getElementById("status").innerHTML = `
            Server not reachable!<br>
            <span style='font-size:0.98em;color:#fa7268;'>Check if Node.js server is running.</span>`;
          document.getElementById("servertime").innerHTML = "";
          document.getElementById("sprint-title").textContent =
            "‚ùå Server Down";
          document.getElementById("sprint-content").innerHTML =
            "<div class='no-sprint'>Could not load project data because the server is not reachable.</div>";
        });
    </script>
  </body>
</html>
